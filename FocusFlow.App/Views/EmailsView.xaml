<UserControl
    x:Class="FocusFlow.App.Views.EmailsView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:FocusFlow.App"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="clr-namespace:FocusFlow.App.ViewModels"
    d:DesignHeight="600"
    d:DesignWidth="800"
    mc:Ignorable="d">

    <Grid Margin="20">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*" />
            <ColumnDefinition Width="3*" />
        </Grid.ColumnDefinitions>

        <!--  Left: Email List  -->
        <Grid Grid.Column="0" Margin="0,0,10,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!--  Header  -->
            <StackPanel
                Grid.Row="0"
                Margin="0,0,0,10"
                Orientation="Horizontal">
                <TextBlock
                    VerticalAlignment="Center"
                    FontSize="24"
                    FontWeight="Bold"
                    Text="Emails" />
                <Button
                    Margin="20,0,0,0"
                    Padding="10,5"
                    HorizontalAlignment="Left"
                    Command="{Binding ShowNewEmailFormCommand}"
                    Content="+ New" />
            </StackPanel>

            <!--  Search  -->
            <TextBox
                Grid.Row="1"
                Margin="0,0,0,10"
                Padding="5"
                Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}">
                <TextBox.Style>
                    <Style TargetType="TextBox">
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="TextBox">
                                    <Border
                                        Padding="5"
                                        BorderBrush="LightGray"
                                        BorderThickness="1"
                                        CornerRadius="3">
                                        <ScrollViewer x:Name="PART_ContentHost" />
                                    </Border>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </TextBox.Style>
            </TextBox>

            <!--  Email List with Multi-Select  -->
            <Grid Grid.Row="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!--  Bulk Actions  -->
                <StackPanel
                    Grid.Row="0"
                    Margin="0,0,0,10"
                    Orientation="Horizontal"
                    Visibility="{Binding HasSelectedEmails, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Button
                        Padding="10,5"
                        Background="LightCoral"
                        Command="{Binding DeleteSelectedEmailsCommand}"
                        Content="ðŸ—‘ï¸ Delete Selected" />
                    <TextBlock
                        Margin="10,0,0,0"
                        VerticalAlignment="Center"
                        Text="{Binding SelectedEmailsCount, StringFormat='{}{0} selected'}" />
                </StackPanel>

                <ListBox
                    Grid.Row="1"
                    ItemsSource="{Binding EmailItems}"
                    SelectedItem="{Binding SelectedEmailItem}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border
                                Margin="0,5"
                                Padding="10"
                                BorderBrush="LightGray"
                                BorderThickness="1"
                                CornerRadius="5">
                                <StackPanel Orientation="Horizontal">
                                    <CheckBox
                                        Margin="0,0,10,0"
                                        VerticalAlignment="Center"
                                        IsChecked="{Binding IsSelected, Mode=TwoWay}" />
                                    <StackPanel>
                                        <TextBlock
                                            FontWeight="Bold"
                                            Text="{Binding Email.Subject}"
                                            TextWrapping="Wrap" />
                                        <TextBlock
                                            Margin="0,5,0,0"
                                            FontSize="12"
                                            Foreground="Gray"
                                            Text="{Binding Email.From}" />
                                        <!--  datum  -->
                                        <TextBlock
                                            Margin="0,2,0,0"
                                            FontSize="11"
                                            Foreground="Gray"
                                            Text="{Binding Email.ReceivedUtc, StringFormat='{}{0:dd/MM/yyyy HH:mm}'}" />
                                        <!--  priority  -->
                                        <TextBlock
                                            Margin="0,2,0,0"
                                            FontSize="11"
                                            Visibility="{Binding Email.PriorityScore, Converter={StaticResource ZeroToVisibilityConverter}}">
                                            <TextBlock.Text>
                                                <MultiBinding StringFormat="Priority: {0}">
                                                    <Binding Path="Email.PriorityScore" />
                                                </MultiBinding>
                                            </TextBlock.Text>
                                            <TextBlock.Foreground>
                                                <Binding Converter="{StaticResource PriorityToColorConverter}" Path="Email.PriorityScore" />
                                            </TextBlock.Foreground>
                                        </TextBlock>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
            <!--  sluit Grid Grid.Row="2"  -->

        </Grid>
        <!--  sluit linker Grid (Grid.Column="0")  -->

        <!--  Right: Email Detail  -->
        <Border
            Grid.Column="1"
            Padding="15"
            BorderBrush="LightGray"
            BorderThickness="1"
            CornerRadius="5"
            Visibility="{Binding SelectedEmail, Converter={StaticResource NullToVisibilityConverter}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!--  Header with Delete Button  -->
                <StackPanel Grid.Row="0" Margin="0,0,0,15">
                    <StackPanel Margin="0,0,0,10" Orientation="Horizontal">
                        <TextBlock
                            VerticalAlignment="Center"
                            FontSize="20"
                            FontWeight="Bold"
                            Text="{Binding SelectedEmail.Subject}"
                            TextWrapping="Wrap" />
                        <Button
                            Margin="15,0,0,0"
                            Padding="15,5"
                            HorizontalAlignment="Right"
                            Background="LightCoral"
                            Command="{Binding DeleteEmailCommand}"
                            Content="ðŸ—‘ï¸ Delete" />
                    </StackPanel>
                </StackPanel>

                <!--  Scrollable Content  -->
                <ScrollViewer Grid.Row="1">
                    <StackPanel>

                        <TextBlock Margin="0,0,0,5">
                            <Run FontWeight="Bold" Text="From:" />
                            <Run Text="{Binding SelectedEmail.From}" />
                        </TextBlock>

                        <TextBlock Margin="0,0,0,5">
                            <Run FontWeight="Bold" Text="Date:" />
                            <Run Text="{Binding SelectedEmail.ReceivedUtc, StringFormat='{}{0:dd/MM/yyyy HH:mm}'}" />
                        </TextBlock>

                        <Separator Margin="0,10,0,10" />

                        <!--  Priority Section  -->
                        <TextBlock
                            Margin="0,0,0,5"
                            FontSize="16"
                            FontWeight="Bold"
                            Text="Priority" />

                        <StackPanel Margin="0,0,0,15" Orientation="Horizontal">
                            <Slider
                                Width="200"
                                Margin="0,0,10,0"
                                Maximum="100"
                                Minimum="0"
                                Value="{Binding EmailPriorityScore, UpdateSourceTrigger=PropertyChanged}" />
                            <TextBlock
                                MinWidth="50"
                                VerticalAlignment="Center"
                                Text="{Binding EmailPriorityScore, StringFormat='{}{0}'}" />
                            <Button
                                Margin="10,0,0,0"
                                Padding="10,5"
                                Command="{Binding UpdateEmailPriorityCommand}"
                                Content="Update Priority" />
                        </StackPanel>

                        <Separator Margin="0,10,0,10" />

                        <TextBlock
                            Margin="0,0,0,5"
                            FontSize="16"
                            FontWeight="Bold"
                            Text="Summary" />

                        <TextBlock
                            Margin="0,0,0,15"
                            Text="{Binding EmailSummary}"
                            TextWrapping="Wrap"
                            Visibility="{Binding EmailSummary, Converter={StaticResource NullToVisibilityConverter}}" />

                        <TextBlock
                            Margin="0,0,0,15"
                            Foreground="Gray"
                            Text="No summary available"
                            Visibility="{Binding EmailSummary, Converter={StaticResource NullToInverseVisibilityConverter}}" />

                        <Separator Margin="0,10,0,10" />

                        <TextBlock
                            Margin="0,0,0,5"
                            FontSize="16"
                            FontWeight="Bold"
                            Text="Body" />

                        <TextBlock
                            Margin="0,0,0,10"
                            Text="{Binding SelectedEmail.BodyText}"
                            TextWrapping="Wrap" />
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>

        <!--  New Email Form (Overlay)  -->
        <Border
            Grid.ColumnSpan="2"
            Width="500"
            Padding="20"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            Background="White"
            BorderBrush="Black"
            BorderThickness="2"
            CornerRadius="10"
            Visibility="{Binding IsEmailFormVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel>
                <TextBlock
                    Margin="0,0,0,20"
                    FontSize="18"
                    FontWeight="Bold"
                    Text="New Email" />

                <TextBlock Margin="0,0,0,5" Text="From *" />
                <TextBox Margin="0,0,0,15" Text="{Binding EmailFrom, UpdateSourceTrigger=PropertyChanged}" />

                <TextBlock Margin="0,0,0,5" Text="Subject *" />
                <TextBox Margin="0,0,0,15" Text="{Binding EmailSubject, UpdateSourceTrigger=PropertyChanged}" />

                <TextBlock Margin="0,0,0,5" Text="Body" />
                <TextBox
                    Height="150"
                    Margin="0,0,0,15"
                    AcceptsReturn="True"
                    Text="{Binding EmailBody, UpdateSourceTrigger=PropertyChanged}"
                    TextWrapping="Wrap" />

                <TextBlock Margin="0,0,0,5" Text="Received Date" />
                <DatePicker Margin="0,0,0,15" SelectedDate="{Binding EmailReceivedDate}" />

                <StackPanel HorizontalAlignment="Right" Orientation="Horizontal">
                    <Button
                        Margin="5,0"
                        Padding="15,5"
                        Command="{Binding CancelEmailFormCommand}"
                        Content="Cancel" />
                    <Button
                        Margin="5,0"
                        Padding="15,5"
                        Background="LightGreen"
                        Command="{Binding SaveEmailCommand}"
                        Content="Save" />
                </StackPanel>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>